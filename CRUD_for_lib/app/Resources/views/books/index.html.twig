{% extends 'base_bootstrap.html.twig' %}
{% block JSHead %}
    <script>
        let savedBookId;
        let base_server_url = 'http://127.0.0.1:8000/';

        function sendRequest(method, path, params = null) {
            const Http = new XMLHttpRequest();
            Http.open(method, path);
            if (method === "POST") {
                Http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                Http.send(params);
                return;
            }
            Http.send();
        }

        function changeAuthor(authorId, bookId) {
            const newAuthorName = document.getElementById(authorId.toString() + bookId.toString() + '_name').value;
            const newAuthor2Name = document.getElementById(authorId.toString() + bookId.toString() + '_2name').value;
            sendRequest("GET", base_server_url + 'authors/changeName/' + authorId + '/' + newAuthorName + '/' + newAuthor2Name);
        }

        function addAuthor(bookId) {
            const newName = prompt("Enter Author Name:");
            const newSecondNAme = prompt("Enter Author Second Name:");
            if (newName == null || newSecondNAme == null || newName == "" || newSecondNAme == "")
                return;
            sendRequest("GET", base_server_url + 'books/addAuthor/' + bookId + '/' + newName + '/' + newSecondNAme);
        }

        function attachExistingAuthor(authorId) {
            sendRequest("GET", base_server_url + 'books/attachExistingAuthor/' + authorId + '/' + savedBookId);
        }

        function unfastenExistingAuthor(authorId) {
            sendRequest("GET", base_server_url + 'books/unfastenExistingAuthor/' + authorId + '/' + savedBookId);
        }

        function editBookTitle(bookId, defaultTitle) {
            const newBookTitle = prompt('Enter new title', defaultTitle);
            if (newBookTitle == null || newBookTitle == '')
                return;
            sendRequest("GET", base_server_url + 'books/editBookTitle/' + bookId + '/' + newBookTitle);
        }

        function editBookDesc(isSaving) {
            let bookDesc = document.getElementById("book_" + savedBookId);
            bookDesc = bookDesc.innerText;
            let bookDescText = document.getElementById("bookDescTextModal");
            bookDescText.innerText = bookDesc;
            if (!isSaving)
                return;
            console.log(document.getElementById("bookDescTextModal").value);
            sendRequest("POST", base_server_url + "books/editBookDesc/" + savedBookId, "desc=" + document.getElementById("bookDescTextModal").value)

        }


    </script>
{% endblock %}

{% block body %}
    <h1>Books list</h1>

    <table class="table table-dark">
        <thead>
        <tr>
            <th scope="col">Id</th>
            <th scope="col">Title</th>
            <th scope="col">Description</th>
            <th scope="col">Image</th>
            <th scope="col">Realise date</th>
            <th scope="col">Authors</th>
        </tr>
        </thead>
        <tbody>

        {% for book in books %}
            <tr>
                <th scope="row">{{ book.bookId }}</th>
                <td>
                    <div class="container">
                        <div class="row">{{ book.bookName }}</div>
                        <div class="row">
                            <button type="button" class="btn btn-sm btn-primary"
                                    onclick="editBookTitle({{ book.bookId }}, '{{ book.bookName }}')">
                                Edit book title
                            </button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="container">
                        <div class="row">
                            <p id="book_{{ book.bookId }}">{{ book.bookDesc }}</p>
                        </div>
                        <div class="row">
                            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal"
                                    data-target="#exampleModalLong"
                                    onclick="savedBookId = {{ book.bookId }}; editBookDesc(false);">
                                Edit book description
                            </button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="container">
                        <div class="row p-1 col-12">
                            <img src="{{ book.bookImg }}" alt="No image" width="150px" height="150px">
                        </div>
                        <div class="row p-1 col-12">
                            <form method="POST" enctype="multipart/form-data"
                                  action="{{ path('set_new_img', {'bookId': book.bookId}) }}">
                                <div class="custom-file mb-3">
                                    <input type="hidden" name="MAX_FILE_SIZE" value="150000">
                                    <input type="file" class="custom-file-input" name="new_book_img" required>
                                    <label class="custom-file-label" for="validatedCustomFile">Choose new img</label>
                                </div>
                                <input type="submit">
                            </form>
                        </div>
                    </div>

                </td>
                <td>{% if book.bookPubDate %}{{ book.bookPubDate|date('Y-m-d') }}{% endif %}</td>
                <td>
                    <ul>
                        {% for author in book.author %}
                            <li>
                                <input type="text" value="{{ author.getAuthorName }}"
                                       id="{{ author.getAuthorId }}{{ book.getBookId }}_name">
                                <input type="text" value="{{ author.getAuthorSecondName }}"
                                       id="{{ author.getAuthorId }}{{ book.getBookId }}_2name">
                                <button type="button" class="btn btn-sm btn-warning"
                                        onclick="changeAuthor({{ author.getAuthorId }}, {{ book.getBookId }})">Change
                                    Author
                                </button>

                            </li>
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn btn-primary" onclick="addAuthor({{ book.bookId }})">
                        Add new Co-Author
                    </button>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#attachUnfastenModal"
                            onclick="savedBookId={{ book.bookId }}">
                        Attach/Unfasten existing Author
                    </button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class=" w-100 row px-3">
        <form class="row col-12 col-xl-6" enctype="multipart/form-data" action="{{ path('form_process') }}"
              method="post">
            <div class="col-6 col-lg-4 mb-3">Enter book title: <input type="text" name="book_title"></div>
            <div class="col-6 offset-lg-4 col-lg-4 mb-3">Enter book published date : <input type="date"
                                                                                            name="book_date"></div>
            <div class="col-12 mb-3">Enter book description: <textarea class="w-100" name="book_desc"></textarea></div>
            <input type="hidden" name="MAX_FILE_SIZE" value="150000">
            <div class="custom-file col-6 mb-3">
                <input type="file" class="custom-file-input" id="validatedCustomFile" name="book_img" required>
                <label class="custom-file-label" for="validatedCustomFile">Choose file...</label>
                <div class="invalid-feedback">Example invalid custom file feedback</div>
            </div>
            <input class="col-4 offset-2" type="submit" value="Add new book">
        </form>

    </div>

    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
         aria-hidden="true" onchange="alert()">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modalBookDesc">
                    <div class="row justify-content-center"><textarea class="col-11" id="bookDescTextModal"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editBookDesc(true)">Save changes</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block modalBody %}
    {% for author in authors %}
        <div class="row mb-1">

            <div class="col-6">{{ author.getAuthorName }} {{ author.getAuthorSecondName }} </div>

            <div class="col-6">
                <button type="button" class="btn btn-success btn-sm"
                        onclick="attachExistingAuthor({{ author.authorId }})">Add author
                </button>
                <button type="button" class="btn btn-danger btn-sm"
                        onclick="unfastenExistingAuthor({{ author.authorId }})">Delete author
                </button>
            </div>

        </div>
    {% endfor %}
{% endblock %}

{% block modalHeader %}
    Edit authors.
{% endblock %}